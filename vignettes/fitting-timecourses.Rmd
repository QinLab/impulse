---
title: "Fitting Timecourses"
author: "Sean R. Hackett"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r simulate_timecourses}
library(impulse)
library(dplyr)
library(ggplot2)

timecourses <- simulate_timecourses(n = 20)

# plot of timecourses + parameters

timecourses %>%
  tidyr::unnest(measurements) %>%
  tidyr::unite(label, true_model, tc_id) %>%
  ggplot(aes(x = time)) +
  geom_point(aes(y = abundance)) +
  geom_path(aes(y = sim_fit)) +
  facet_wrap(~ label)
```


```{r estimate_parameters}
timecourse_parameters <- timecourses %>%
  tidyr::unnest(measurements) %>%
  # separate by true model
  tidyr::nest(-true_model, .key = "measurements") %>%
  # fit all models to each timecourse
  tidyr::crossing(tibble::tibble(model = c("sigmoid", "impulse"))) %>%
  dplyr::mutate(timecourse_params = purrr::map2(measurements, model, estimate_timecourse_params_tf, n_initializations = 50),
                loss = purrr::map(timecourse_params, function(x){x$loss}),
                parameters = purrr::map(timecourse_params, function(x){x$loss}))

```

```{r}
timecourse_parameters
```


```{r compare_models}

```
